{% extends "admin/base_site.html" %}
{% load static %}
{% load i18n %}

{% block title %}Liste des Payouts{% endblock %}

{% block extrahead %}
<style>
    .filters-container {
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        margin-bottom: 20px;
    }
    
    .filters-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin-bottom: 15px;
    }
    
    .filter-group {
        display: flex;
        flex-direction: column;
    }
    
    .filter-group label {
        font-weight: bold;
        margin-bottom: 5px;
        color: #333;
    }
    
    .filter-group select,
    .filter-group input {
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 14px;
    }
    
    .filter-actions {
        display: flex;
        gap: 10px;
        align-items: end;
    }
    
    .btn {
        padding: 8px 16px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        text-decoration: none;
        display: inline-block;
        font-size: 14px;
    }
    
    .btn-primary { background: #007cba; color: white; }
    .btn-secondary { background: #6c757d; color: white; }
    .btn-success { background: #4caf50; color: white; }
    
    .btn:hover { opacity: 0.9; }
    
    .table-responsive {
        overflow-x: auto;
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .table {
        width: 100%;
        border-collapse: collapse;
        margin: 0;
    }
    
    .table th, .table td {
        padding: 12px;
        text-align: left;
        border-bottom: 1px solid #ddd;
    }
    
    .table th {
        background: #f5f5f5;
        font-weight: bold;
        position: sticky;
        top: 0;
    }
    
    .table tbody tr:hover {
        background: #f8f9fa;
    }
    
    .status-badge {
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 0.8em;
        font-weight: bold;
        text-transform: uppercase;
    }
    
    .status-pending { background: #fff3cd; color: #856404; }
    .status-processing { background: #d1ecf1; color: #0c5460; }
    .status-completed { background: #d4edda; color: #155724; }
    .status-failed { background: #f8d7da; color: #721c24; }
    
    .amount-cell {
        font-weight: bold;
        color: #007cba;
    }
    
    .phone-cell {
        font-family: monospace;
        font-size: 0.9em;
    }
    
    .payment-method-badge {
        background: rgba(108, 92, 231, 0.1);
        color: #6c5ce7;
        padding: 2px 6px;
        border-radius: 4px;
        font-size: 0.75em;
        font-weight: 500;
        border: 1px solid rgba(108, 92, 231, 0.3);
    }
    
    .pagination {
        display: flex;
        justify-content: center;
        align-items: center;
        margin-top: 20px;
        gap: 10px;
    }
    
    .pagination a,
    .pagination span {
        padding: 8px 12px;
        border: 1px solid #ddd;
        text-decoration: none;
        color: #007cba;
    }
    
    .pagination .current {
        background: #007cba;
        color: white;
        border-color: #007cba;
    }
    
    .bulk-actions {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 4px;
        margin-bottom: 20px;
        display: flex;
        gap: 10px;
        align-items: center;
    }
    
    .bulk-actions select {
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
    }
    
    .stats-summary {
        background: #e3f2fd;
        padding: 15px;
        border-radius: 4px;
        margin-bottom: 20px;
        display: flex;
        gap: 30px;
        flex-wrap: wrap;
    }
    
    .stat-item {
        display: flex;
        flex-direction: column;
        align-items: center;
    }
    
    .stat-number {
        font-size: 1.5em;
        font-weight: bold;
        color: #1976d2;
    }
    
    .stat-label {
        font-size: 0.9em;
        color: #666;
    }
    
    .status-select {
        width: 100%;
        padding: 4px 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 12px;
        background: white;
        cursor: pointer;
    }
    
    .status-select:focus {
        outline: none;
        border-color: #007cba;
        box-shadow: 0 0 0 2px rgba(0, 124, 186, 0.2);
    }
    
    .status-select option {
        padding: 4px;
    }
</style>
{% endblock %}

{% block content %}
<div class="payout-list">
    <h1>üí∞ Gestion des Payouts</h1>
    
    <!-- Statistiques rapides -->
    <div class="stats-summary">
        <div class="stat-item">
            <div class="stat-number">{{ payouts.paginator.count }}</div>
            <div class="stat-label">Total affich√©</div>
        </div>
        <div class="stat-item">
            <div class="stat-number">{{ payouts.paginator.count|floatformat:0 }}</div>
            <div class="stat-label">Montant total (EUR)</div>
        </div>
        <div class="stat-item">
            <div class="stat-number">{{ total_amount_xof|floatformat:0 }}</div>
            <div class="stat-label">Montant total (XOF)</div>
        </div>
    </div>
    
    <!-- Filtres -->
    <div class="filters-container">
        <h3>üîç Filtres</h3>
        <form method="get" class="filters-form">
            <div class="filters-grid">
                <div class="filter-group">
                    <label for="status">{% trans "Statut" %}</label>
                    <select name="status" id="status">
                        <option value="">Tous les statuts</option>
                        {% for value, label in status_choices %}
                        <option value="{{ value }}" {% if current_filters.status == value %}selected{% endif %}>
                            {{ label }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="filter-group">
                    <label for="operator">Op√©rateur</label>
                    <select name="operator" id="operator">
                        <option value="">Tous les op√©rateurs</option>
                        {% for operator in operator_choices %}
                        <option value="{{ operator }}" {% if current_filters.operator == operator %}selected{% endif %}>
                            {{ operator|upper }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="filter-group">
                    <label for="country">{% trans "Pays" %}</label>
                    <select name="country" id="country">
                        <option value="">Tous les pays</option>
                        {% for country in country_choices %}
                        <option value="{{ country }}" {% if current_filters.country == country %}selected{% endif %}>
                            {{ country }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="filter-group">
                    <label for="search">Recherche</label>
                    <input type="text" name="search" id="search" 
                           value="{{ current_filters.search }}" 
                           placeholder="T√©l√©phone, ID, vendeur...">
                </div>
            </div>
            
            <div class="filter-actions">
                <button type="submit" class="btn btn-primary">üîç Filtrer</button>
                <a href="{% url 'admin_payout_list' %}" class="btn btn-secondary">üîÑ R√©initialiser</a>
                <a href="{% url 'admin_export_payouts_csv' %}" class="btn btn-success">üì• Exporter CSV</a>
            </div>
        </form>
    </div>
    
    <!-- Actions en masse -->
    <div class="bulk-actions">
        <span>Actions en masse :</span>
        <select id="bulk-action">
            <option value="">S√©lectionner une action</option>
            <option value="mark_processing">Marquer en cours</option>
            <option value="mark_completed">Marquer termin√©</option>
            <option value="mark_failed">Marquer √©chou√©</option>
        </select>
        <button onclick="applyBulkAction()" class="btn btn-primary">Appliquer</button>
    </div>
    
    <!-- Tableau des payouts -->
    <div class="table-responsive">
        <table class="table">
            <thead>
                <tr>
                    <th><input type="checkbox" id="select-all"></th>
                    <th>ID</th>
                    <th>{% trans "Vendeur" %}</th>
                    <th>Montant</th>
                    <th>B√©n√©ficiaire</th>
                    <th>{% trans "Statut" %}</th>
                    <th>Type</th>
                    <th>Date</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for payout in payouts %}
                <tr>
                    <td><input type="checkbox" class="payout-checkbox" value="{{ payout.id }}"></td>
                    <td><code>{{ payout.id|slice:":8" }}</code></td>
                    <td>
                        {% if payout.escrow_transaction.cinetpay_transaction.transaction.seller %}
                            {{ payout.escrow_transaction.cinetpay_transaction.transaction.seller.username }}
                        {% else %}
                            N/A
                        {% endif %}
                    </td>
                    <td class="amount-cell">
                        {% if payout.payout_type == 'seller_payout' %}
                            <div style="font-size: 0.9em;">
                                <strong>{{ payout.amount }} {{ payout.currency }}</strong><br>
                                <small style="color: #666;">(90% de {{ payout.original_amount|default:payout.amount }} {{ payout.currency }})</small>
                            </div>
                        {% elif payout.payout_type == 'buyer_refund' %}
                            <div style="font-size: 0.9em;">
                                <strong>{{ payout.amount }} {{ payout.currency }}</strong><br>
                                <small style="color: #666;">(100% remboursement)</small>
                            </div>
                        {% else %}
                            {{ payout.amount }} {{ payout.currency }}
                        {% endif %}
                    </td>
                    <td class="phone-cell">
                        <strong>{{ payout.recipient_phone }}</strong><br>
                        <small>{{ payout.recipient_country }} - {{ payout.recipient_operator|upper }}</small>
                        {% if payout.escrow_transaction.cinetpay_transaction.transaction.seller.payment_info %}
                            <br><small class="payment-method-badge">
                                {% if payout.escrow_transaction.cinetpay_transaction.transaction.seller.payment_info.preferred_payment_method == 'mobile_money' %}
                                    üì± Mobile Money
                                {% elif payout.escrow_transaction.cinetpay_transaction.transaction.seller.payment_info.preferred_payment_method == 'bank_transfer' %}
                                    üè¶ Virement Bancaire
                                {% elif payout.escrow_transaction.cinetpay_transaction.transaction.seller.payment_info.preferred_payment_method == 'card' %}
                                    üí≥ Carte Bancaire
                                {% endif %}
                            </small>
                        {% endif %}
                    </td>
                    <td>
                        <select class="status-select" data-payout-id="{{ payout.id }}" onchange="updatePayoutStatus(this)">
                            <option value="pending" {% if payout.status == 'pending' %}selected{% endif %}>{% trans "En attente" %}</option>
                            <option value="processing" {% if payout.status == 'processing' %}selected{% endif %}>En cours</option>
                            <option value="completed" {% if payout.status == 'completed' %}selected{% endif %}>Termin√©</option>
                            <option value="failed" {% if payout.status == 'failed' %}selected{% endif %}>√âchou√©</option>
                        </select>
                        <div class="status-badge status-{{ payout.status }}" style="margin-top: 5px;">
                            {{ payout.get_status_display }}
                        </div>
                    </td>
                    <td>
                        {% if payout.payout_type == 'seller_payout' %}
                            <span class="status-badge" style="background: #d4edda; color: #155724;">
                                üí∞ Paiement Vendeur

                        {% elif payout.payout_type == 'buyer_refund' %}
                            <span class="status-badge" style="background: #fff3cd; color: #856404;">
                                üîÑ Remboursement

                            {% with transaction=payout.escrow_transaction.cinetpay_transaction.transaction %}
                                {% if transaction.dispute %}
                                    <br><small style="color: #dc3545; font-weight: bold;">
                                        ‚öñÔ∏è Litige r√©solu
                                    </small>
                                    {% if transaction.dispute.chat %}
                                        <br><a href="{% url 'admin_dispute_detail' transaction.dispute.id %}" 
                                               style="font-size: 11px; color: #007cba; text-decoration: none;"
                                               title="Voir le chat du litige">
                                            üí¨ Voir chat litige
                                        </a>
                                    {% endif %}
                                {% endif %}
                            {% endwith %}
                        {% endif %}
                    </td>
                    <td>{{ payout.created_at|date:"d/m/Y H:i" }}</td>
                    <td>
                        <a href="{% url 'admin:blizzgame_payoutrequest_change' payout.id %}" 
                           class="btn btn-primary" style="padding: 4px 8px; font-size: 12px;">
                            ‚úèÔ∏è Modifier
                        </a>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="9" style="text-align: center; padding: 40px; color: #666;">
                        Aucun payout trouv√© avec ces filtres.
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    
    <!-- Pagination -->
    {% if payouts.has_other_pages %}
    <div class="pagination">
        {% if payouts.has_previous %}
            <a href="?page=1{% for key, value in current_filters.items %}{% if value %}&{{ key }}={{ value }}{% endif %}{% endfor %}">¬´ Premi√®re</a>
            <a href="?page={{ payouts.previous_page_number }}{% for key, value in current_filters.items %}{% if value %}&{{ key }}={{ value }}{% endif %}{% endfor %}">‚Äπ Pr√©c√©dente</a>
        {% endif %}
        
        <span class="current">
            Page {{ payouts.number }} sur {{ payouts.paginator.num_pages }}

        
        {% if payouts.has_next %}
            <a href="?page={{ payouts.next_page_number }}{% for key, value in current_filters.items %}{% if value %}&{{ key }}={{ value }}{% endif %}{% endfor %}">Suivante ‚Ä∫</a>
            <a href="?page={{ payouts.paginator.num_pages }}{% for key, value in current_filters.items %}{% if value %}&{{ key }}={{ value }}{% endif %}{% endfor %}">Derni√®re ¬ª</a>
        {% endif %}
    </div>
    {% endif %}
</div>

<script>
// S√©lection multiple
document.getElementById('select-all').addEventListener('change', function() {
    const checkboxes = document.querySelectorAll('.payout-checkbox');
    checkboxes.forEach(checkbox => {
        checkbox.checked = this.checked;
    });
});

// Actions en masse
function applyBulkAction() {
    const action = document.getElementById('bulk-action').value;
    const selectedPayouts = Array.from(document.querySelectorAll('.payout-checkbox:checked'))
        .map(cb => cb.value);
    
    if (!action) {
        alert('Veuillez s√©lectionner une action.');
        return;
    }
    
    if (selectedPayouts.length === 0) {
        alert('Veuillez s√©lectionner au moins un payout.');
        return;
    }
    
    if (confirm(`Appliquer l'action "${action}" √† ${selectedPayouts.length} payout(s) ?`)) {
        // Ici vous pouvez impl√©menter l'action en masse via AJAX
        console.log('Action:', action, 'Payouts:', selectedPayouts);
        alert('Action appliqu√©e ! (Fonctionnalit√© √† impl√©menter)');
    }
}

// Mise √† jour du statut d'un payout
function updatePayoutStatus(selectElement) {
    const payoutId = selectElement.dataset.payoutId;
    const newStatus = selectElement.value;
    
    // Mise √† jour directe sans confirmation
        // Afficher un indicateur de chargement
        selectElement.disabled = true;
        selectElement.style.opacity = '0.6';
        
        // Envoyer la requ√™te AJAX
        fetch(`/payouts/update-status/${payoutId}/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                'status': newStatus
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Mettre √† jour le badge de statut
                const statusBadge = selectElement.nextElementSibling;
                statusBadge.className = `status-badge status-${newStatus}`;
                statusBadge.textContent = data.status_display;
                
                // Afficher un message de succ√®s
                showNotification('‚úÖ Statut mis √† jour avec succ√®s !', 'success');
            } else {
                // Restaurer l'ancien statut en cas d'erreur
                selectElement.value = selectElement.dataset.originalValue;
                showNotification('‚ùå Erreur lors de la mise √† jour : ' + data.error, 'error');
            }
        })
        .catch(error => {
            console.error('Erreur:', error);
            // Restaurer l'ancien statut en cas d'erreur
            selectElement.value = selectElement.dataset.originalValue;
            showNotification('‚ùå Erreur de connexion', 'error');
        })
        .finally(() => {
            // R√©activer le s√©lecteur
            selectElement.disabled = false;
            selectElement.style.opacity = '1';
        });
}

// Fonction pour r√©cup√©rer le cookie CSRF
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Fonction pour afficher des notifications
function showNotification(message, type = 'info') {
    // Cr√©er l'√©l√©ment de notification
    const notification = document.createElement('div');
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 15px 20px;
        border-radius: 4px;
        color: white;
        font-weight: bold;
        z-index: 1000;
        max-width: 300px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    `;
    
    // Couleur selon le type
    if (type === 'success') {
        notification.style.backgroundColor = '#4caf50';
    } else if (type === 'error') {
        notification.style.backgroundColor = '#f44336';
    } else {
        notification.style.backgroundColor = '#2196f3';
    }
    
    notification.textContent = message;
    document.body.appendChild(notification);
    
    // Supprimer apr√®s 3 secondes
    setTimeout(() => {
        notification.remove();
    }, 3000);
}

// Initialiser les valeurs originales des s√©lecteurs
document.addEventListener('DOMContentLoaded', function() {
    const statusSelects = document.querySelectorAll('.status-select');
    statusSelects.forEach(select => {
        select.dataset.originalValue = select.value;
    });
});
</script>
{% endblock %}
