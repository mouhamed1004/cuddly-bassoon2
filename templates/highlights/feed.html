{% load static %}
{% load i18n %}
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Highlights Gaming - Blizz</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="{% static 'css/highlights.css' %}">
    <link rel="stylesheet" href="{% static 'css/appreciation.css' %}">
    <!-- CSRF Token for AJAX -->
    <meta name="csrf-token" content="{{ csrf_token }}">
    <style>
        /* Variables CSS globales */
        :root {
            --primary-color: #6c5ce7;
            --accent-color: #a29bfe;
            --text-color: #ffffff;
            --bg-color: #0f1729;
            --secondary-bg: #1a2332;
            --border-color: rgba(108, 92, 231, 0.3);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--bg-color);
            color: var(--text-color);
            overflow: hidden;
            height: 100vh;
        }

        /* Styles pour les hashtags */
        .hashtags-display {
            margin-top: 0.5rem;
            display: flex;
            flex-wrap: wrap;
            gap: 0.3rem;
        }

        .hashtag-tag {
            background: rgba(108, 92, 231, 0.3);
            color: var(--primary-color);
            padding: 0.2rem 0.5rem;
            border-radius: 10px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1px solid rgba(108, 92, 231, 0.5);
        }

        .hashtag-tag:hover {
            background: var(--primary-color);
            color: white;
            transform: scale(1.05);
        }

        .hashtag-more {
            color: var(--text-color);
            opacity: 0.7;
            font-size: 0.8rem;
            padding: 0.2rem 0.5rem;
        }

        /* Styles pour les descriptions longues */
        .caption-container {
            margin-top: 0.3rem;
        }

        .toggle-caption-btn {
            background: none;
            border: none;
            color: var(--primary-color);
            cursor: pointer;
            font-size: 0.8rem;
            padding: 0.2rem 0;
            margin-left: 0.5rem;
            transition: all 0.3s ease;
        }

        .toggle-caption-btn:hover {
            text-shadow: 0 0 10px var(--primary-color);
            transform: scale(1.05);
        }

        .caption-short, .caption-full {
            display: inline;
        }

        /* Indicateur pour les nouveaux highlights */
        .new-indicator {
            background: linear-gradient(45deg, #ff6b6b, #ff8e53);
            color: white;
            font-size: 0.7rem;
            font-weight: bold;
            padding: 0.2rem 0.5rem;
            border-radius: 10px;
            margin-left: 0.5rem;
            animation: pulse 2s infinite;
            box-shadow: 0 2px 10px rgba(255, 107, 107, 0.3);
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
    </style>
</head>
<body>
    <!-- Hidden CSRF Token for JavaScript -->
    {% csrf_token %}
    
    <!-- Custom Alert Overlay -->
    <div id="customAlert" class="custom-alert-overlay" style="display: none;">
        <div class="custom-alert-box">
            <div class="alert-icon">
                <i class="fas fa-info-circle"></i>
            </div>
            <div class="alert-content">
                <h3 id="alertTitle">Information</h3>
                <p id="alertMessage">Message</p>
            </div>
            <button class="alert-close-btn" onclick="closeCustomAlert()">
                <i class="fas fa-times"></i>
            </button>
        </div>
    </div>
    
    <div class="highlights-container">
    <!-- Header TikTok-like avec bouton retour - √âPAISSEUR R√âDUITE -->
    <div class="highlights-header">
        <div class="header-left">
            <a href="{% url 'index' %}" class="exit-btn">
                <i class="fas fa-door-open"></i>
            </a>
        </div>
        <div class="header-tabs">
            <a href="{% url 'highlights_for_you' %}" class="header-tab {% if request.resolver_match.url_name == 'highlights_for_you' %}active{% endif %}">
                <span>Pour toi</span>
            </a>
            <a href="{% url 'highlights_friends' %}" class="header-tab {% if request.resolver_match.url_name == 'highlights_friends' %}active{% endif %}">
                <span>Amis</span>
        </a>
        {% if user.is_authenticated %}
            <a href="{% url 'create_highlight' %}" class="header-tab create-tab">
                <span>{% trans "Cr√©er" %}</span>
        </a>
        {% endif %}
        </div>
        <div class="header-actions">
            <a href="{% url 'highlights_search' %}" class="search-btn">
                <i class="fas fa-search"></i>
            </a>
        </div>
    </div>

    <!-- Container principal des highlights -->
    <div class="highlights-viewer" id="highlightsViewer">
    {% if highlights %}
                {% for highlight in highlights %}
            <div class="highlight-card" data-highlight-id="{{ highlight.id }}" data-index="{{ forloop.counter0 }}" id="highlight-{{ highlight.id }}">
                <!-- Vid√©o principale en format vertical - DIMENSIONS R√âDUITES -->
                <div class="video-container">
                    <video 
                        class="highlight-video" 
                        preload="none" 
                        loop 
                        playsinline
                        muted
                        data-highlight-id="{{ highlight.id }}"
                        data-original-src="{{ highlight.video.url }}"
                        poster="{{ highlight.thumbnail.url|default:'' }}"
                        loading="lazy"
                    >
                        <source src="{{ highlight.video.url }}" type="video/mp4">
                    </video>
                    
                    <!-- Boutons d'action SUR la vid√©o √† droite - COMME TIKTOK - TAILLE R√âDUITE - REPOSITIONN√âS -->
                    <div class="actions-overlay">
                        <!-- Actions compactes -->
                        <div class="compact-actions">
                            <!-- Profil utilisateur avec bouton follow -->
                            <div class="user-profile">
                                <div class="profile-pic" onclick="viewProfile('{{ highlight.author.username }}')">
                                    <img src="{% if highlight.author.profile and highlight.author.profile.profileimg %}{{ highlight.author.profile|cloudinary_or_static:'profileimg' }}{% else %}<img src="{% static \'images/default-avatar.png\' %}" alt="Profile">{% endif %}" alt="Profile">
                                </div>
                                <button class="follow-btn" onclick="toggleFollow('{{ highlight.author.id }}')">
                                    <i class="fas fa-plus"></i>
                                </button>
                            </div>

                            <!-- Syst√®me d'appr√©ciation -->
                            {% if user.is_authenticated %}
                            <div class="appreciation-container" data-highlight-id="{{ highlight.id }}">
                                <div class="appreciation-buttons">
                                    <button class="appreciation-button {% if highlight.user_appreciation.appreciation_level == 6 %}selected{% endif %}" data-level="6" data-highlight-id="{{ highlight.id }}">
                                        <span class="appreciation-emoji">ü§©</span>
                                        <div class="appreciation-count">{{ highlight.appreciation_counts.6|default:0 }}</div>
                                        <div class="appreciation-tooltip">Extraordinaire</div>
                                    </button>
                                    <button class="appreciation-button {% if highlight.user_appreciation.appreciation_level == 5 %}selected{% endif %}" data-level="5" data-highlight-id="{{ highlight.id }}">
                                        <span class="appreciation-emoji">üò≤</span>
                                        <div class="appreciation-count">{{ highlight.appreciation_counts.5|default:0 }}</div>
                                        <div class="appreciation-tooltip">Tr√®s bien</div>
                                    </button>
                                    <button class="appreciation-button {% if highlight.user_appreciation.appreciation_level == 4 %}selected{% endif %}" data-level="4" data-highlight-id="{{ highlight.id }}">
                                        <span class="appreciation-emoji">üòÆ</span>
                                        <div class="appreciation-count">{{ highlight.appreciation_counts.4|default:0 }}</div>
                                        <div class="appreciation-tooltip">Bien</div>
                                    </button>
                                    <button class="appreciation-button {% if highlight.user_appreciation.appreciation_level == 3 %}selected{% endif %}" data-level="3" data-highlight-id="{{ highlight.id }}">
                                        <span class="appreciation-emoji">üôÇ</span>
                                        <div class="appreciation-count">{{ highlight.appreciation_counts.3|default:0 }}</div>
                                        <div class="appreciation-tooltip">Moyen</div>
                                    </button>
                                    <button class="appreciation-button {% if highlight.user_appreciation.appreciation_level == 2 %}selected{% endif %}" data-level="2" data-highlight-id="{{ highlight.id }}">
                                        <span class="appreciation-emoji">ü§¢</span>
                                        <div class="appreciation-count">{{ highlight.appreciation_counts.2|default:0 }}</div>
                                        <div class="appreciation-tooltip">Pas terrible</div>
                                    </button>
                                    <button class="appreciation-button {% if highlight.user_appreciation.appreciation_level == 1 %}selected{% endif %}" data-level="1" data-highlight-id="{{ highlight.id }}">
                                        <span class="appreciation-emoji">ü§Æ</span>
                                        <div class="appreciation-count">{{ highlight.appreciation_counts.1|default:0 }}</div>
                                        <div class="appreciation-tooltip">Extr√™mement nul</div>
                                    </button>
                                </div>
                            </div>
                            {% endif %}

                            <!-- Actions secondaires -->
                            <div class="action-buttons">
                                <!-- Menu d√©roulant pour actions -->
                                <div class="dropdown-menu">
                                    <button class="dropdown-btn" onclick="toggleDropdown('{{ highlight.id }}')">
                                        <i class="fas fa-ellipsis-h"></i>
                                    </button>
                                    <div class="dropdown-content" id="dropdown-{{ highlight.id }}">
                                        <button class="dropdown-item" onclick="shareHighlight('{{ highlight.id }}')">
                                            <i class="fas fa-share"></i> Partager
                                        </button>
                                        <button class="dropdown-item" onclick="downloadHighlight('{{ highlight.id }}')">
                                            <i class="fas fa-download"></i> T√©l√©charger
                                        </button>
                                        {% if user.is_authenticated and user != highlight.author %}
                                        <button class="dropdown-item" onclick="openReportModal('{{ highlight.id }}', '{{ highlight.author.id }}')">
                                            <i class="fas fa-flag"></i> Signaler
                                        </button>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Informations utilisateur et titre SUR la vid√©o en bas √† gauche -->
                    <div class="video-info-overlay">
                        <div class="user-info">
                            <span class="username">@{{ highlight.author.username }}</span>
                            <div class="caption-container" data-highlight-id="{{ highlight.id }}">
                                <p class="caption">
                                    {% if highlight.caption|length > 20 %}
                                        <span id="short-{{ highlight.id }}">{{ highlight.caption|slice:":20" }}...</span>
                                        <span id="full-{{ highlight.id }}" style="display: none;">{{ highlight.caption|default:"Aucun titre" }}</span>
                                        <br>
                                        <button class="toggle-caption-btn" onclick="toggleText('{{ highlight.id }}')">
                                            <span id="btn-{{ highlight.id }}">{% trans "Voir plus" %}</span>
                                        </button>
                                    {% else %}
                                        {{ highlight.caption|default:"Aucun titre" }}
                                    {% endif %}
                                </p>
                            </div>
                            {% if highlight.hashtags %}
                            <div class="hashtags-display">
                                {% if highlight.hashtags %}
                                    {% for hashtag in highlight.hashtags %}
                                        {% if forloop.counter <= 5 %}
                                        <span class="hashtag-tag" onclick="searchHashtag('{{ hashtag }}')">#{{ hashtag }}</span>
                                        {% elif forloop.counter == 6 %}
                                        <span class="hashtag-more">+{{ highlight.hashtags|length|add:"-5" }} autres</span>
                                        {% endif %}
                                    {% endfor %}
                                {% endif %}
                            </div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Barre de progression en bas -->
                    <div class="progress-bar">
                        <div class="progress-fill"></div>
                </div>
                </div>

            <!-- Menu plus d'options -->
                <div class="more-options-menu" id="more-options-{{ highlight.id }}" style="display: none;">
                    <div class="options-list">
                        <button class="option-item" onclick="reportHighlight('{{ highlight.id }}')">
                            <i class="fas fa-flag"></i>
                            Signaler
                        </button>
                        <button class="option-item" onclick="shareHighlight('{{ highlight.id }}')">
                            <i class="fas fa-share"></i>
                            Partager
                        </button>
                    {% if user.is_authenticated and highlight.author == user %}
                        <button class="option-item delete-btn" onclick="deleteHighlight('{{ highlight.id }}')">
                        <i class="fas fa-trash"></i>{% trans "Supprimer" %}</button>
                    {% endif %}
                </div>
            </div>
        </div>
                {% endfor %}
    {% else %}
    <!-- √âtat vide -->
    <div class="empty-state">
        <div class="empty-icon">
            <i class="fas fa-video"></i>
        </div>
        <h3>Aucun Highlight pour le moment</h3>
        <p>
            {% if request.resolver_match.url_name == 'highlights_friends' %}
            Vos amis n'ont pas encore partag√© de Highlights.
            {% else %}
            Il n'y a pas encore de Highlights disponibles.
            {% endif %}
        </p>
        {% if request.resolver_match.url_name != 'highlights_friends' %}
            {% if user.is_authenticated %}
            <a href="{% url 'create_highlight' %}" class="create-first-btn">
                <i class="fas fa-plus"></i>
                Cr√©er le premier Highlight
            </a>
            {% else %}
            <a href="{% url 'signin' %}" class="create-first-btn">
                <i class="fas fa-sign-in-alt"></i>
                Se connecter pour cr√©er
            </a>
            {% endif %}
        {% endif %}
    </div>
    {% endif %}
    </div>

    <!-- Navigation par fl√®ches - GARD√âES L√Ä O√ô ELLES SONT -->
    <div class="navigation-arrows">
        <button class="nav-arrow prev-arrow" onclick="previousHighlight()">
            <i class="fas fa-chevron-up"></i>
        </button>
        <button class="nav-arrow next-arrow" onclick="nextHighlight()">
            <i class="fas fa-chevron-down"></i>
        </button>
    </div>
</div>

<style>
/* Variables CSS - Utilisation du th√®me principal */
:root {
    --primary-color: #6c5ce7;
    --secondary-color: #a29bfe;
    --accent-color: #ff6b6b;
    --success-color: #00b894;
    --warning-color: #fdcb6e;
    --error-color: #e17055;
    --text-color: #ffffff;
    --text-secondary: #b8b8b8;
    --bg-dark: #0f1729; /* Couleur du th√®me principal au lieu du noir */
    --bg-card: #1a2332; /* Version plus claire du th√®me principal */
    --border-color: rgba(108, 92, 231, 0.2);
    --shadow-color: rgba(0, 0, 0, 0.3);
}

* {
        margin: 0;
    padding: 0;
    box-sizing: border-box;
}

/* Container principal - format vertical comme TikTok */
.highlights-container {
    width: 100%;
    height: 100vh;
    background: var(--bg-dark);
    position: relative;
    overflow: hidden;
}

/* Custom Alert Styles */
.custom-alert-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(15, 23, 41, 0.8);
    backdrop-filter: blur(10px);
    z-index: 10000;
    display: flex;
    align-items: center;
    justify-content: center;
    animation: fadeIn 0.3s ease;
}

.custom-alert-box {
    background: linear-gradient(135deg, var(--bg-card), var(--primary-color));
    border: 2px solid var(--primary-color);
    border-radius: 20px;
    padding: 2rem;
    max-width: 400px;
    width: 90%;
    position: relative;
    box-shadow: 0 20px 40px rgba(108, 92, 231, 0.3);
    animation: slideInUp 0.3s ease;
}

.alert-icon {
    text-align: center;
    margin-bottom: 1rem;
}

.alert-icon i {
    font-size: 3rem;
    color: var(--primary-color);
    filter: drop-shadow(0 0 10px var(--primary-color));
}

.alert-content h3 {
    color: var(--text-color);
    font-size: 1.5rem;
    margin-bottom: 0.5rem;
    text-align: center;
    font-weight: 600;
}

.alert-content p {
    color: var(--text-secondary);
    font-size: 1rem;
    text-align: center;
    line-height: 1.5;
    margin-bottom: 1.5rem;
}

.alert-close-btn {
    position: absolute;
    top: 1rem;
    right: 1rem;
    background: rgba(255, 107, 107, 0.2);
    border: 1px solid var(--error-color);
    color: var(--error-color);
    border-radius: 50%;
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.3s ease;
    outline: none;
}

.alert-close-btn:hover {
    background: var(--error-color);
    color: white;
    transform: scale(1.1);
}

@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

@keyframes slideInUp {
    from {
        transform: translateY(50px);
        opacity: 0;
    }
    to {
        transform: translateY(0);
        opacity: 1;
    }
}

/* Header TikTok-like avec bouton retour - √âPAISSEUR R√âDUITE */
.highlights-header {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    z-index: 1000;
    background: linear-gradient(180deg, rgba(15, 23, 41, 0.95) 0%, transparent 100%);
    padding: 0.5rem 2rem; /* R√âDUIT de 1rem √† 0.5rem */
    display: flex;
    justify-content: space-between;
    align-items: center;
    /* Removed backdrop-filter to prevent interference with video */
    height: 50px; /* HAUTEUR FIXE R√âDUITE */
    /* Ensure this header doesn't affect video below */
    pointer-events: auto;
}

/* Ensure header elements have proper pointer events */
.highlights-header * {
    pointer-events: auto;
}

.header-left {
        display: flex;
    align-items: center;
    }

.exit-btn {
    background: rgba(108, 92, 231, 0.2);
    border: 1px solid var(--primary-color);
    color: var(--primary-color);
    width: 44px;
    height: 44px;
    border-radius: 50%;
    font-size: 1.2rem;
    cursor: pointer;
    transition: all 0.3s ease;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    text-decoration: none;
    outline: none;
}

.exit-btn:hover {
    background: var(--primary-color);
    color: white;
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(108, 92, 231, 0.4);
}

.header-tabs {
        display: flex;
        gap: 2rem;
    }

.header-tab {
    color: var(--text-secondary);
    text-decoration: none;
    font-weight: 600;
    font-size: 1rem; /* R√âDUIT */
    padding: 0.3rem 0; /* R√âDUIT */
        position: relative;
    transition: color 0.3s ease;
}

.header-tab.active {
    color: var(--text-color);
}

.header-tab.active::after {
    content: '';
        position: absolute;
    bottom: 0;
        left: 0;
    right: 0;
    height: 2px;
    background: var(--primary-color);
    border-radius: 1px;
}

/* Style sp√©cial pour le bouton Cr√©er */
.header-tab.create-tab {
    background: rgba(108, 92, 231, 0.1);
    border: 1px solid var(--primary-color);
    border-radius: 15px;
    padding: 0.3rem 1rem;
    transition: all 0.3s ease;
}

.header-tab.create-tab:hover {
    background: var(--primary-color);
    color: white;
    transform: translateY(-1px);
    box-shadow: 0 3px 10px rgba(108, 92, 231, 0.3);
}

.header-actions {
        display: flex;
    gap: 1rem;
}

.search-btn {
    width: 35px; /* R√âDUIT */
    height: 35px; /* R√âDUIT */
        border-radius: 50%;
    background: rgba(108, 92, 231, 0.2);
    border: 1px solid var(--primary-color);
    color: var(--text-color);
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.3s ease;
    text-decoration: none; /* Enlever la d√©coration */
    }
    
.search-btn:hover {
    background: var(--primary-color);
        transform: scale(1.1);
}

/* Viewer principal - format vertical */
.highlights-viewer {
    width: 100%;
    height: 100vh;
    overflow-y: scroll;
    scroll-snap-type: y mandatory;
    scroll-behavior: smooth;
}

/* Carte de highlight - FORMAT VERTICAL 9:16 */
.highlight-card {
    width: 100%;
    height: 100vh;
    position: relative;
    scroll-snap-align: start;
    display: flex;
    background: var(--bg-dark);
    justify-content: center;
}

/* Container vid√©o - FORMAT VERTICAL CENTR√â avec DIMENSIONS R√âDUITES et CENTRAGE PARFAIT */
.video-container {
    position: relative;
    width: 100%;
    max-width: 350px; /* R√âDUIT de 400px √† 350px pour voir les contours */
    height: 85vh; /* R√âDUIT de 90vh √† 85vh pour √©viter l'espace excessif */
    background: #000;
    overflow: hidden;
    display: flex;
    flex-direction: column;
    margin: 12vh 0 7vh 0; /* Marge TOP augment√©e pour plus d'espace avec le header */
    border-radius: 15px; /* Coins arrondis pour plus d'√©l√©gance */
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5); /* Ombre pour d√©limiter */
}

.highlight-video {
    width: 100%;
    height: 100%;
    object-fit: cover;
    background: #000;
    /* Prevent any unwanted effects */
    transition: none !important;
    transform: none !important;
    /* Explicit filter prevention */
    -webkit-filter: none !important;
    filter: none !important;
    backdrop-filter: none !important;
    -webkit-backdrop-filter: none !important;
    /* Ensure clean video display */
    isolation: isolate;
}

/* Prevent any hover effects on video container */
.video-container:hover,
.highlight-card:hover,
.highlight-video:hover {
    /* Explicitly prevent any changes */
    transform: none !important;
    filter: none !important;
    opacity: 1 !important;
    background: inherit !important;
    backdrop-filter: none !important;
}

/* Ensure no blur effects affect the video area */
.video-container,
.highlight-video,
.highlight-card {
    backdrop-filter: none !important;
    filter: none !important;
}

/* Prevent any overlay elements from affecting video display */
.video-container *:hover {
    backdrop-filter: none !important;
    filter: none !important;
}

/* Global blur prevention for video area */
.highlight-card:hover .video-container,
.highlight-card:hover .highlight-video,
.highlight-card .video-container:hover,
.highlight-card .highlight-video:hover {
    backdrop-filter: none !important;
    filter: none !important;
    -webkit-filter: none !important;
}

/* Ensure no pseudo-elements create blur effects */
.video-container::before,
.video-container::after,
.highlight-video::before,
.highlight-video::after,
.highlight-card::before,
.highlight-card::after {
    backdrop-filter: none !important;
    filter: none !important;
    display: none !important;
}

/* Force remove any inherited blur effects */
.video-container,
.video-container *,
.highlight-video {
    -webkit-backdrop-filter: none !important;
    backdrop-filter: none !important;
    -webkit-filter: none !important;
    filter: none !important;
}

/* Barre de progression */
.progress-bar {
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
    height: 3px;
    background: rgba(255, 255, 255, 0.2);
}

.progress-fill {
    height: 100%;
    background: linear-gradient(90deg, var(--primary-color), var(--accent-color));
    width: 0%;
    transition: width 0.1s linear;
    border-radius: 2px;
}
    
/* Boutons d'action SUR la vid√©o √† droite - COMME TIKTOK - TAILLE R√âDUITE - REPOSITIONN√âS */
.actions-overlay {
        position: absolute;
    right: 0.4rem;
    bottom: 1rem; /* Positionn√© tout en bas */
    display: flex;
    flex-direction: column;
    gap: 1rem;
    z-index: 100;
    align-items: center;
}

/* Informations utilisateur et titre SUR la vid√©o en bas √† gauche */
.video-info-overlay {
    position: absolute;
    left: 1rem;
    bottom: 2rem;
    z-index: 100;
    color: white;
    text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
}

.user-info {
        display: flex;
    flex-direction: column;
    gap: 0.3rem;
}

.user-info .username {
    font-size: 1rem;
    font-weight: 700;
    color: white;
    text-decoration: none;
}

.user-info .caption {
    font-size: 0.9rem;
    color: rgba(255, 255, 255, 0.9);
    margin: 0;
    max-width: 200px;
    line-height: 1.3;
    word-wrap: break-word;
}

/* Styles pour les √©l√©ments de profil et boutons d'action */
.user-profile {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.1rem; /* R√©duit pour rapprocher les √©l√©ments */
    position: relative;
}
    
.profile-pic {
        width: 50px;
        height: 50px;
        border-radius: 50%;
    overflow: hidden;
    cursor: pointer;
    position: relative;
    }

.profile-pic img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.follow-btn {
    width: 22px;
    height: 22px;
    border-radius: 50%;
    background: var(--accent-color);
    border: none;
    color: white;
    font-size: 0.6rem;
    cursor: pointer;
    position: absolute;
    bottom: -8px;
    left: 50%;
    transform: translateX(-50%);
    z-index: 10;
    display: flex;
    align-items: center;
    justify-content: center;
}

/* Actions compactes - Positionnement vers le bas */
.compact-actions {
    display: flex;
    flex-direction: column;
    gap: 0.05rem;
    align-items: center;
}

/* Boutons d'action avec compteurs - TAILLE R√âDUITE */
.action-buttons {
    display: flex;
    flex-direction: column;
    gap: 0.1rem;
}

.action-btn {
    background: transparent;
    border: none;
    color: white;
    cursor: pointer;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.2rem; /* R√©duit de 0.3rem √† 0.2rem */
    /* Removed transition to prevent unwanted effects */
}

/* Styles pour le menu d√©roulant */
.dropdown-menu {
    position: relative;
    display: inline-block;
}

.dropdown-content {
    display: none;
    position: fixed;
    right: 20px;
    top: 20px;
    background: rgba(15, 23, 41, 0.95);
    border: 1px solid var(--primary-color);
    border-radius: 10px;
    min-width: 180px;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
    backdrop-filter: blur(10px);
    z-index: 9999;
}

.dropdown-content.show {
    display: block;
}

.dropdown-item {
    display: block;
    padding: 12px 16px;
    color: white;
    text-decoration: none;
    transition: all 0.3s ease;
    cursor: pointer;
    border: none;
    background: none;
    width: 100%;
    text-align: left;
    font-size: 0.9rem;
}

.dropdown-item:hover {
    background: var(--primary-color);
    color: white;
}

.dropdown-item:first-child {
    border-radius: 10px 10px 0 0;
}

.dropdown-item:last-child {
    border-radius: 0 0 10px 10px;
}

.dropdown-btn {
    background: rgba(255, 255, 255, 0.1);
    border: 1px solid rgba(255, 255, 255, 0.2);
    color: var(--text-color);
    border-radius: 50%;
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.3s ease;
    backdrop-filter: blur(10px);
    font-size: 1rem;
    position: relative;
}

.dropdown-btn:hover {
    background: var(--primary-color);
    border-color: var(--primary-color);
    transform: scale(1.1);
}

/* Supprimer les styles conflictuels pour √©viter la superposition */
.dropdown-menu .action-btn {
    display: none;
}

.action-btn i {
    font-size: 1.2rem; /* R√©duit de 1.5rem √† 1.2rem */
    width: 40px; /* R√©duit de 50px √† 40px */
    height: 40px; /* R√©duit de 50px √† 40px */
    background: rgba(255, 255, 255, 0.1);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    /* Removed transition to prevent unwanted effects */
}

/* Removed hover effect that could interfere with video display */

.action-btn.liked i {
    color: var(--accent-color);
    animation: heartBeat 0.3s ease;
}

@keyframes heartBeat {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.2); }
}

.action-count {
    font-size: 0.7rem; /* R√©duit de 0.8rem √† 0.7rem */
    color: var(--text-secondary);
    font-weight: 600;
    min-width: 25px; /* R√©duit de 30px √† 25px */
    text-align: center;
}

/* Bouton t√©l√©chargement sp√©cial - TAILLE R√âDUITE */
.download-btn .action-count {
    font-size: 0.6rem; /* R√©duit de 0.7rem √† 0.6rem */
    max-width: 50px; /* R√©duit de 60px √† 50px */
    line-height: 1.2;
}

/* Styles pour les informations utilisateur sur la vid√©o */
.username {
    font-weight: 600;
    font-size: 1rem;
    margin-bottom: 0.5rem;
    display: block;
    color: white;
    text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8);
}

.caption {
    font-size: 0.9rem;
    line-height: 1.4;
    margin-bottom: 0.5rem;
    opacity: 0.9;
    max-width: 300px;
    color: white;
    text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8);
}

/* Menu plus d'options */
.more-options-menu {
    position: absolute;
    top: 50%;
    right: 8rem;
    background: rgba(15, 23, 41, 0.95);
    border-radius: 15px;
    padding: 1rem;
    z-index: 300;
    min-width: 200px;
    backdrop-filter: blur(20px);
    border: 1px solid var(--border-color);
}

.options-list {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
}

.option-item {
    background: transparent;
    border: none;
    color: white;
    padding: 0.8rem 1rem;
    text-align: left;
    cursor: pointer;
    border-radius: 10px;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 0.8rem;
}

.option-item:hover {
    background: rgba(108, 92, 231, 0.1);
}

.option-item.delete-btn {
    color: var(--error-color);
}

/* Navigation par fl√®ches - GARD√âES L√Ä O√ô ELLES SONT */
.navigation-arrows {
    position: fixed;
    right: 2rem;
    top: 50%;
    transform: translateY(-50%);
    display: flex;
    flex-direction: column;
    gap: 1rem;
    z-index: 100;
}

.nav-arrow {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    background: rgba(108, 92, 231, 0.2);
    border: 1px solid var(--primary-color);
    color: white;
    font-size: 1.2rem;
    cursor: pointer;
    transition: all 0.3s ease;
    /* Removed backdrop-filter to prevent interference */
}

.nav-arrow:hover {
    background: var(--primary-color);
    transform: scale(1.1);
    box-shadow: 0 5px 15px rgba(108, 92, 231, 0.4);
}

.nav-arrow:disabled {
    opacity: 0.3;
    cursor: not-allowed;
}

/* √âtat vide */
.empty-state {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 100vh;
    text-align: center;
    color: var(--text-secondary);
}

.empty-icon {
    font-size: 4rem;
    margin-bottom: 2rem;
    opacity: 0.5;
}

.create-first-btn {
    background: var(--primary-color);
    color: white;
        text-decoration: none;
    padding: 1rem 2rem;
    border-radius: 25px;
    margin-top: 2rem;
    transition: all 0.3s ease;
}

.create-first-btn:hover {
    background: var(--secondary-color);
    transform: translateY(-2px);
}

/* Responsive Design - Boutons r√©duits et repositionn√©s */
@media (max-width: 768px) {
    .highlights-header {
        padding: 0.4rem 1rem;
        height: 45px;
    }
    
    .header-tabs {
        gap: 1rem;
    }
    
    .header-tab {
        font-size: 0.9rem;
        padding: 0.2rem 0;
    }
    
    .video-container {
        max-width: 320px;
        height: 80vh;
        margin: 10vh 0 10vh 0;
    }
    
    .actions-overlay {
        right: 0.3rem; /* R√©duit pour mobile */
        bottom: 1.5rem; /* Ajust√© pour mobile */
        gap: 0.8rem;
    }
    
    .video-info-overlay {
        left: 0.8rem; /* R√©duit pour mobile */
        bottom: 1.5rem; /* Ajust√© pour mobile */
    }
    
    .profile-pic {
        width: 45px;
        height: 45px;
    }
    
    .action-btn i {
        width: 35px;
        height: 35px;
        font-size: 1.1rem;
    }
    
    .follow-btn {
        width: 20px;
        height: 20px;
        font-size: 0.5rem;
    }
    
    .user-info .username {
    font-size: 0.9rem;
}

    .user-info .caption {
        font-size: 0.8rem;
        max-width: 180px;
    }
    
    .bottom-info {
        left: 0.5rem;
        right: 6rem;
        bottom: 1.5rem;
    }
    
    /* Masquer les fl√®ches sur mobile */
    .navigation-arrows {
        display: none !important;
    }
}

@media (max-width: 480px) {
    .actions-overlay {
        right: 0.2rem;
        bottom: 1.2rem; /* Ajust√© pour petit mobile */
        gap: 0.6rem;
    }
    
    .video-info-overlay {
        left: 0.6rem; /* R√©duit pour petit mobile */
        bottom: 1.2rem; /* Ajust√© pour petit mobile */
    }
    
    .profile-pic {
        width: 40px;
        height: 40px;
    }
    
    .action-btn i {
        width: 30px;
        height: 30px;
        font-size: 1rem;
    }
    
    .follow-btn {
        width: 18px;
        height: 18px;
        font-size: 0.4rem;
    }
    
    .user-info .username {
        font-size: 0.8rem;
    }
    
    .user-info .caption {
        font-size: 0.7rem;
        max-width: 160px;
    }
    

    
    .username {
        font-size: 0.9rem;
    }
    
    .caption {
        font-size: 0.8rem;
    }
    
    .back-btn {
        padding: 0.4rem 0.7rem;
        font-size: 0.7rem;
    }
    
    .video-container {
        max-width: 300px;
        height: 75vh;
        margin: 12vh 0 13vh 0;
    }
}

/* Scrollbar personnalis√©e */
.highlights-viewer::-webkit-scrollbar {
    width: 0;
}

.highlights-viewer::-webkit-scrollbar-track {
    background: transparent;
}

.highlights-viewer::-webkit-scrollbar-thumb {
    background: transparent;
}

/* Am√©liorations visuelles suppl√©mentaires */
.highlight-card {
    position: relative;
}

.highlight-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(45deg, transparent, rgba(108, 92, 231, 0.05));
    pointer-events: none;
    z-index: 1;
}

/* Animation d'entr√©e pour les highlights */
@keyframes slideInFromBottom {
    from {
        transform: translateY(100%);
        opacity: 0;
    }
    to {
        transform: translateY(0);
        opacity: 1;
    }
}

.highlight-card {
    animation: slideInFromBottom 0.5s ease-out;
}

/* Effet de focus pour l'accessibilit√© */
.action-btn:focus,
.nav-arrow:focus,
.comment-input:focus {
    outline: none;
    box-shadow: 0 0 0 2px rgba(108, 92, 231, 0.3);
}

/* Remove default button outlines and focus states */
.action-btn,
.follow-btn,
.exit-btn,
.alert-close-btn {
    outline: none;
    border: none;
    -webkit-tap-highlight-color: transparent;
    -webkit-touch-callout: none;
    -webkit-user-select: none;
    -khtml-user-select: none;
    -moz-user-select: none;
    -ms-user-select: none;
    user-select: none;
}

.action-btn:focus,
.action-btn:active,
.follow-btn:focus,
.follow-btn:active {
    outline: none !important;
    border: none !important;
    box-shadow: none !important;
}

/* Mode sombre am√©lior√© */
@media (prefers-color-scheme: dark) {
    .highlight-card {
        background: var(--bg-dark);
    }
    
    .comments-section {
        background: rgba(15, 23, 41, 0.98);
    }
}

/* Am√©lioration de l'accessibilit√© */
@media (prefers-reduced-motion: reduce) {
    * {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
        }
    }
</style>

<script>
// Custom Alert Functions
function showCustomAlert(title, message, type = 'info') {
    const alertOverlay = document.getElementById('customAlert');
    const alertTitle = document.getElementById('alertTitle');
    const alertMessage = document.getElementById('alertMessage');
    const alertIcon = alertOverlay.querySelector('.alert-icon i');
    
    // Set content
    alertTitle.textContent = title;
    alertMessage.textContent = message;
    
    // Set icon based on type
    alertIcon.className = '';
    switch(type) {
        case 'success':
            alertIcon.className = 'fas fa-check-circle';
            alertIcon.style.color = 'var(--success-color)';
            break;
        case 'error':
            alertIcon.className = 'fas fa-exclamation-triangle';
            alertIcon.style.color = 'var(--error-color)';
            break;
        case 'warning':
            alertIcon.className = 'fas fa-exclamation-circle';
            alertIcon.style.color = 'var(--warning-color)';
            break;
        default:
            alertIcon.className = 'fas fa-info-circle';
            alertIcon.style.color = 'var(--primary-color)';
    }
    
    // Show alert
    alertOverlay.style.display = 'flex';
    
    // Auto close after 3 seconds for success messages
    if (type === 'success') {
        setTimeout(() => {
            closeCustomAlert();
        }, 3000);
    }
}

function closeCustomAlert() {
    const alertOverlay = document.getElementById('customAlert');
    alertOverlay.style.display = 'none';
}

// Close alert when clicking outside
document.addEventListener('click', function(event) {
    const alertOverlay = document.getElementById('customAlert');
    const alertBox = alertOverlay.querySelector('.custom-alert-box');
    
    if (event.target === alertOverlay && !alertBox.contains(event.target)) {
        closeCustomAlert();
    }
});

// ANCIEN SYST√àME - D√©sactiv√© au profit du nouveau TikTok Feed System
// Variables globales
let currentHighlightIndex = 0;
let highlights = [];
let isPlaying = false;
let isMouseOverVideo = false; // Track mouse hover state

// Initialisation D√âSACTIV√âE - Remplac√©e par TikTok Feed
/*
document.addEventListener('DOMContentLoaded', function() {
    // Si le nouveau syst√®me est actif, ne pas initialiser l'ancien
    if (window.tiktokFeed) {
        console.log('Nouveau syst√®me TikTok Feed actif, ancien syst√®me d√©sactiv√©');
        return;
    }
    
    highlights = Array.from(document.querySelectorAll('.highlight-card'));
    
    // Ensure all videos have proper sources
    highlights.forEach(highlight => {
        const video = highlight.querySelector('video');
        if (video && !video.src && video.getAttribute('data-original-src')) {
            video.src = video.getAttribute('data-original-src');
        }
        
        // Add mouse event listeners to track hover state
        highlight.addEventListener('mouseenter', () => {
            isMouseOverVideo = true;
        });
        
        highlight.addEventListener('mouseleave', () => {
            isMouseOverVideo = false;
        });
    });
    
    // V√©rifier si un highlight sp√©cifique est demand√© via l'URL hash
    const targetHighlightId = getTargetHighlightFromUrl();
    let startIndex = 0;
    
    if (targetHighlightId) {
        const targetIndex = highlights.findIndex(h => h.getAttribute('data-highlight-id') === targetHighlightId);
        if (targetIndex !== -1) {
            startIndex = targetIndex;
        }
    }
    
    if (highlights.length > 0) {
        // Si on a un highlight cible, navigation instantan√©e
        showHighlight(startIndex, targetHighlightId ? true : false);
        setupVideoProgress();
        setupSwipeNavigation();
    }
    
    updateNavigationButtons();
    
    // Masquer les fl√®ches sur mobile
    if (window.innerWidth <= 768) {
        document.querySelector('.navigation-arrows').style.display = 'none';
    }
});
*/

// Fonction de retour
function goBack() {
    if (history.length > 1) {
        history.back();
    } else {
        window.location.href = '/';
    }
}

// Navigation des highlights - REMPLAC√âE par TikTok Feed System
// Ces fonctions sont maintenant g√©r√©es dans tiktok-feed.js
/*
function nextHighlight() {
    if (currentHighlightIndex < highlights.length - 1) {
        showHighlight(currentHighlightIndex + 1);
    }
}

function previousHighlight() {
    if (currentHighlightIndex > 0) {
        showHighlight(currentHighlightIndex - 1);
    }
}
*/

// ANCIENNE fonction showHighlight - Remplac√©e par TikTok Feed System
/*
function showHighlight(index, instant = false) {
    if (index < 0 || index >= highlights.length) return;
    
    // Arr√™ter la vid√©o pr√©c√©dente
    if (currentHighlightIndex !== index) {
        const previousVideo = highlights[currentHighlightIndex]?.querySelector('video');
        if (previousVideo) {
            previousVideo.pause();
            previousVideo.currentTime = 0;
        }
    }
    
    // Mettre √† jour l'index
    currentHighlightIndex = index;
    
    // Faire d√©filer vers le highlight
    const targetHighlight = highlights[index];
    const container = document.getElementById('highlightsViewer');
    
    if (instant) {
        // Navigation instantan√©e sans animation
        targetHighlight.scrollIntoView({ 
            behavior: 'auto',
            block: 'start'
        });
        
        // D√©marrer la vid√©o imm√©diatement
        const currentVideo = targetHighlight.querySelector('video');
        if (currentVideo) {
            // Ensure video source is loaded
            if (!currentVideo.src && currentVideo.getAttribute('data-original-src')) {
                currentVideo.src = currentVideo.getAttribute('data-original-src');
                currentVideo.load();
            }
            // Play immediately
            setTimeout(() => {
                if (currentVideo.paused && currentVideo.readyState >= 2) {
                    currentVideo.play().catch(e => console.log('Autoplay prevented:', e));
                }
            }, 100);
        }
    } else {
        // Navigation fluide pour la navigation manuelle
        const containerRect = container.getBoundingClientRect();
        const targetRect = targetHighlight.getBoundingClientRect();
        const scrollTop = container.scrollTop + targetRect.top - containerRect.top;
        
        container.scrollTo({
            top: scrollTop,
            behavior: 'smooth'
        });
        
        // D√©marrer la nouvelle vid√©o apr√®s le scroll
        setTimeout(() => {
            const currentVideo = highlights[index].querySelector('video');
            if (currentVideo) {
                if (!currentVideo.src && currentVideo.getAttribute('data-original-src')) {
                    currentVideo.src = currentVideo.getAttribute('data-original-src');
                    currentVideo.load();
                }
                if (currentVideo.paused && currentVideo.readyState >= 2) {
                    currentVideo.play().catch(e => console.log('Autoplay prevented:', e));
                }
            }
        }, 500);
    }
    
    updateNavigationButtons();
}
*/

// Mise √† jour des boutons de navigation
function updateNavigationButtons() {
    const prevArrow = document.querySelector('.prev-arrow');
    const nextArrow = document.querySelector('.next-arrow');
    
    if (prevArrow) {
        prevArrow.disabled = currentHighlightIndex === 0;
    }
    
    if (nextArrow) {
        nextArrow.disabled = currentHighlightIndex === highlights.length - 1;
    }
}

// Configuration de la progression vid√©o - AM√âLIOR√âE
function setupVideoProgress() {
    highlights.forEach((highlight, index) => {
        const video = highlight.querySelector('video');
        const progressFill = highlight.querySelector('.progress-fill');
        
        if (video && progressFill) {
            video.addEventListener('timeupdate', () => {
                if (video.duration) {
                    const progress = (video.currentTime / video.duration) * 100;
                    progressFill.style.width = progress + '%';
                }
            });
            
            video.addEventListener('ended', () => {
                // Auto-play next video avec d√©lai pour √©viter les conflits
                if (index < highlights.length - 1) {
                    setTimeout(() => nextHighlight(), 1500); // D√©lai augment√©
                }
            });
        }
    });
}

// Navigation par swipe (mobile) - AM√âLIOR√âE
function setupSwipeNavigation() {
    let startY = 0;
    let endY = 0;
    let isScrolling = false;
    
    highlights.forEach(highlight => {
        highlight.addEventListener('touchstart', (e) => {
            if (isScrolling) return;
            startY = e.touches[0].clientY;
        });
        
        highlight.addEventListener('touchend', (e) => {
            if (isScrolling) return;
            endY = e.changedTouches[0].clientY;
            const diffY = startY - endY;
            
            if (Math.abs(diffY) > 80) { // Seuil augment√© pour √©viter les d√©clenchements accidentels
                isScrolling = true;
                
                if (diffY > 0 && currentHighlightIndex < highlights.length - 1) {
                    // Swipe vers le haut
                    nextHighlight();
                } else if (diffY < 0 && currentHighlightIndex > 0) {
                    // Swipe vers le bas
                    previousHighlight();
                }
                
                // D√©lai pour √©viter les swipes multiples
                setTimeout(() => {
                    isScrolling = false;
                }, 1000);
            }
        });
    });
}

// Actions sociales
function toggleLike(highlightId) {
    console.log('toggleLike called with highlightId:', highlightId);
    
    // V√©rifier l'authentification
    if (!getCookie('csrftoken')) {
        console.log('No CSRF token, redirecting to signin');
        window.location.href = '/signin/';
        return;
    }
    
    console.log('CSRF token found:', getCookie('csrftoken'));
    
    const highlight = document.querySelector(`[data-highlight-id="${highlightId}"]`);
    if (!highlight) {
        console.error('Highlight element not found for ID:', highlightId);
        return;
    }
    
    const likeBtn = highlight.querySelector('.like-btn');
    const likeIcon = likeBtn.querySelector('i');
    const likeCount = likeBtn.querySelector('.action-count');
    
    console.log('Making fetch request to:', `/highlights/${highlightId}/like/`);
    
    // Envoyer la requ√™te au serveur
    fetch(`/highlights/${highlightId}/like/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'X-Requested-With': 'XMLHttpRequest',
            'Content-Type': 'application/json',
        },
    })
    .then(response => {
        console.log('Response status:', response.status);
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        console.log('Response data:', data);
        if (data.success) {
            if (data.liked) {
                likeIcon.classList.add('liked');
                likeIcon.className = 'fas fa-heart liked';
            } else {
                likeIcon.classList.remove('liked');
                likeIcon.className = 'fas fa-heart';
            }
            likeCount.textContent = data.appreciations_count;
        } else {
            console.error('Erreur serveur:', data.error);
            showCustomAlert('Erreur', data.error || 'Erreur inconnue', 'error');
        }
    })
    .catch(error => {
        console.error('Erreur AJAX:', error);
        showCustomAlert('Erreur de connexion', 'Veuillez r√©essayer.', 'error');
    });
}

// Fonction pour rechercher un hashtag
function searchHashtag(hashtag) {
    window.location.href = `/highlights/search/?q=%23${encodeURIComponent(hashtag)}`;
}

// Fonction simple pour basculer l'affichage des descriptions
function toggleText(highlightId) {
    const shortText = document.getElementById('short-' + highlightId);
    const fullText = document.getElementById('full-' + highlightId);
    const button = document.getElementById('btn-' + highlightId);
    
    if (shortText.style.display === 'none') {
        // Afficher version courte
        shortText.style.display = 'inline';
        fullText.style.display = 'none';
        button.textContent = 'Voir plus';
    } else {
        // Afficher version compl√®te
        shortText.style.display = 'none';
        fullText.style.display = 'inline';
        button.textContent = 'Voir moins';
    }
}

function toggleFollow(userId) {
    // V√©rifier l'authentification
    if (!getCookie('csrftoken')) {
        window.location.href = '/signin/';
        return;
    }
    
    const followBtn = event.target;
    
    // Envoyer la requ√™te au serveur
    fetch(`/subscribe/${userId}/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'X-Requested-With': 'XMLHttpRequest',
            'Content-Type': 'application/json',
        },
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            if (data.subscribed) {
                followBtn.innerHTML = '<i class="fas fa-check"></i>';
                followBtn.style.background = '#28a745';
                followBtn.title = 'Abonn√©';
            } else {
                followBtn.innerHTML = '<i class="fas fa-plus"></i>';
                followBtn.style.background = 'var(--accent-color)';
                followBtn.title = 'S\'abonner';
            }
        } else {
            console.error('Erreur serveur:', data.error);
            showCustomAlert('Erreur', data.error || 'Impossible de s\'abonner', 'error');
        }
    })
    .catch(error => {
        console.error('Erreur AJAX:', error);
        showCustomAlert('Erreur de connexion', 'Veuillez r√©essayer.', 'error');
    });
}

// Fonction pour basculer le menu d√©roulant
function toggleDropdown(highlightId) {
    const dropdown = document.getElementById('dropdown-' + highlightId);
    const button = event.target.closest('.dropdown-btn');
    
    // Fermer tous les autres dropdowns
    document.querySelectorAll('.dropdown-content').forEach(dd => {
        if (dd.id !== 'dropdown-' + highlightId) {
            dd.classList.remove('show');
        }
    });
    
    // Calculer la position du bouton
    const rect = button.getBoundingClientRect();
    const dropdownHeight = 150; // Hauteur approximative du menu
    
    // Positionner le dropdown au-dessus du bouton
    dropdown.style.position = 'fixed';
    dropdown.style.right = (window.innerWidth - rect.right) + 'px';
    dropdown.style.top = (rect.top - dropdownHeight - 10) + 'px';
    
    // Basculer le dropdown actuel
    dropdown.classList.toggle('show');
}

// Fermer les dropdowns si on clique ailleurs
window.addEventListener('click', function(event) {
    if (!event.target.matches('.dropdown-btn') && !event.target.matches('.dropdown-btn i')) {
        document.querySelectorAll('.dropdown-content').forEach(dropdown => {
            dropdown.classList.remove('show');
        });
    }
});

function shareHighlight(highlightId) {
    console.log('shareHighlight called with highlightId:', highlightId);
    
    const url = `${window.location.origin}/highlights/${highlightId}/`;
    console.log('Share URL:', url);
    
    if (navigator.share) {
        console.log('Using native share API');
        navigator.share({
            title: 'Regardez ce highlight sur <span class="notranslate">BLIZZ</span>!',
            url: url,
        });
    } else {
        console.log('Using clipboard fallback');
        navigator.clipboard.writeText(url).then(() => {
            showSuccessAlert('Lien copi√© dans le presse-papiers !', 'Partage');
        }).catch((error) => {
            console.error('Clipboard write failed:', error);
            showCustomAlert('Partage', 'Lien: ' + url, 'info');
        });
    }
    
    // Fermer le dropdown
    const dropdown = document.getElementById('dropdown-' + highlightId);
    if (dropdown) dropdown.classList.remove('show');
}

// Fonction pour t√©l√©charger un highlight
function downloadHighlight(highlightId) {
    const video = document.querySelector(`[data-highlight-id="${highlightId}"] video`);
    if (video && video.src) {
        const link = document.createElement('a');
        link.href = video.src;
        link.download = 'highlight_' + highlightId + '.mp4';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }
    
    // Fermer le dropdown
    const dropdown = document.getElementById('dropdown-' + highlightId);
    if (dropdown) dropdown.classList.remove('show');
}

// Fonction pour ouvrir le modal de signalement
function openReportModal(highlightId, authorId) {
    // Cr√©er le modal s'il n'existe pas
    let modal = document.getElementById('reportModal');
    if (!modal) {
        modal = document.createElement('div');
        modal.id = 'reportModal';
        modal.className = 'modal';
        modal.style.cssText = 'display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5);';
        
        modal.innerHTML = `
            <div class="modal-content" style="background: linear-gradient(135deg, #1a1a2e, #16213e); margin: 10% auto; padding: 30px; border: 2px solid var(--primary-color); width: 500px; border-radius: 15px; box-shadow: 0 20px 40px rgba(0,0,0,0.5); backdrop-filter: blur(10px);">
                <span class="close" onclick="closeReportModal()" style="color: var(--primary-color); float: right; font-size: 28px; font-weight: bold; cursor: pointer; transition: color 0.3s ease;">&times;</span>
                <h3 style="color: white; margin-bottom: 25px; font-family: 'Russo One', sans-serif; text-align: center;">üö© Signaler ce highlight</h3>
                <form id="reportForm">
                    <div class="form-group" style="margin-bottom: 20px;">
                        <label for="reportReason" style="display: block; margin-bottom: 8px; font-weight: bold; color: var(--primary-color);">Raison du signalement :</label>
                        <select id="reportReason" name="reason" style="width: 100%; padding: 12px; border: 2px solid rgba(255,255,255,0.2); border-radius: 8px; background: rgba(255,255,255,0.1); color: white; font-size: 14px;" required>
                            <option value="" style="background: #1a1a2e; color: white;">S√©lectionnez une raison</option>
                            <option value="inappropriate" style="background: #1a1a2e; color: white;">Contenu inappropri√©</option>
                            <option value="spam" style="background: #1a1a2e; color: white;">Spam</option>
                            <option value="harassment" style="background: #1a1a2e; color: white;">Harc√®lement</option>
                            <option value="violence" style="background: #1a1a2e; color: white;">Violence</option>
                            <option value="copyright" style="background: #1a1a2e; color: white;">Violation de droits d'auteur</option>
                            <option value="other" style="background: #1a1a2e; color: white;">Autre</option>
                        </select>
                    </div>
                    <div class="form-group" style="margin-bottom: 25px;">
                        <label for="reportDescription" style="display: block; margin-bottom: 8px; font-weight: bold; color: var(--primary-color);">Description (optionnel) :</label>
                        <textarea id="reportDescription" name="description" style="width: 100%; padding: 12px; border: 2px solid rgba(255,255,255,0.2); border-radius: 8px; background: rgba(255,255,255,0.1); color: white; font-size: 14px; resize: vertical;" rows="4" placeholder="D√©crivez le probl√®me en d√©tail..."></textarea>
                    </div>
                    <div style="text-align: center; margin-top: 25px;">
                        <button type="button" onclick="closeReportModal()" style="margin-right: 15px; padding: 12px 25px; background: rgba(255,255,255,0.1); border: 2px solid rgba(255,255,255,0.3); color: white; border-radius: 8px; cursor: pointer; transition: all 0.3s ease;">{% trans "Annuler" %}</button>
                        <button type="button" onclick="submitReport()" style="padding: 12px 25px; background: linear-gradient(45deg, #ff6b6b, #ff8e53); border: none; color: white; border-radius: 8px; cursor: pointer; font-weight: bold; transition: transform 0.3s ease;">üö© Signaler</button>
                    </div>
                </form>
            </div>
        `;
        
        document.body.appendChild(modal);
    }
    
    // Stocker les IDs pour la soumission
    modal.dataset.highlightId = highlightId;
    modal.dataset.authorId = authorId;
    
    // Afficher le modal
    modal.style.display = 'block';
    
    // Fermer le dropdown
    const dropdown = document.getElementById('dropdown-' + highlightId);
    if (dropdown) dropdown.classList.remove('show');
}

// Fonction pour fermer le modal de signalement
function closeReportModal() {
    const modal = document.getElementById('reportModal');
    if (modal) {
        modal.style.display = 'none';
        document.getElementById('reportForm').reset();
    }
}

// Fonction pour obtenir le token CSRF
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Fonction pour soumettre le signalement
function submitReport() {
    const modal = document.getElementById('reportModal');
    const reason = document.getElementById('reportReason').value;
    const description = document.getElementById('reportDescription').value;
    
    if (!reason) {
        showCustomAlert('Validation', 'Veuillez s√©lectionner une raison pour le signalement.', 'warning');
        return;
    }
    
    // V√©rifier que les IDs sont pr√©sents
    if (!modal.dataset.highlightId) {
        showCustomAlert('Erreur', 'ID du highlight manquant', 'error');
        return;
    }
    
    if (!modal.dataset.authorId) {
        showCustomAlert('Erreur', 'ID de l\'auteur manquant', 'error');
        return;
    }
    
    console.log('Highlight ID:', modal.dataset.highlightId);
    console.log('Author ID:', modal.dataset.authorId);
    
    fetch('/submit-report/', {
        method: 'POST',
        body: JSON.stringify({
            report_type: 'highlight',
            content_id: modal.dataset.highlightId,
            reported_user_id: modal.dataset.authorId,
            reason: reason,
            description: description
        }),
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        }
    })
    .then(response => {
        console.log('Response status:', response.status);
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        console.log('R√©ponse du serveur:', data);
        if (data.success) {
            showCustomAlert('Succ√®s', 'Signalement envoy√© avec succ√®s. Notre √©quipe va examiner le contenu.', 'success');
            closeReportModal();
        } else {
            console.error('Erreur serveur:', data);
            showCustomAlert('Erreur', data.message || data.error || 'Erreur inconnue', 'error');
        }
    })
    .catch(error => {
        console.error('Erreur AJAX:', error);
        showCustomAlert('Erreur de connexion', 'Une erreur est survenue lors de l\'envoi du signalement.', 'error');
    });
}

function recordShare(highlightId) {
    // Enregistrer le partage c√¥t√© serveur si utilisateur connect√©
    if (getCookie('csrftoken')) {
        console.log('Recording share on server');
        fetch(`/highlights/${highlightId}/share/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'X-Requested-With': 'XMLHttpRequest',
                'Content-Type': 'application/json',
            },
        })
        .then(response => {
            console.log('Share record response:', response.status);
            return response.json();
        })
        .then(data => {
            console.log('Share record data:', data);
        })
        .catch(error => {
            console.error('Erreur enregistrement partage:', error);
        });
    } else {
        console.log('No CSRF token, skipping server-side share recording');
    }
}

// NOUVELLE FONCTION : T√©l√©chargement de highlight
function downloadHighlight(highlightId) {
    console.log('downloadHighlight called with highlightId:', highlightId);
    
    const highlight = document.querySelector(`[data-highlight-id="${highlightId}"]`);
    if (!highlight) {
        console.error('Highlight element not found for ID:', highlightId);
        return;
    }
    
    const video = highlight.querySelector('video');
    if (!video) {
        console.error('Video element not found in highlight:', highlightId);
        return;
    }
    
    // Try multiple sources for the video URL
    let videoUrl = null;
    
    // First, try the current src
    if (video.src && video.src !== window.location.href) {
        videoUrl = video.src;
        console.log('Using current video src:', videoUrl);
    }
    // Then try the data-original-src attribute
    else if (video.getAttribute('data-original-src')) {
        videoUrl = video.getAttribute('data-original-src');
        console.log('Using data-original-src:', videoUrl);
    }
    // Finally, try the source element
    else {
        const source = video.querySelector('source');
        if (source && source.src) {
            videoUrl = source.src;
            console.log('Using source element src:', videoUrl);
        }
    }
    
    console.log('Final video URL:', videoUrl);
    
    if (videoUrl && videoUrl !== window.location.href) {
        console.log('Starting download for:', videoUrl);
        
        try {
            // Cr√©er un lien de t√©l√©chargement
            const downloadLink = document.createElement('a');
            downloadLink.href = videoUrl;
            downloadLink.download = `highlight-${highlightId}.mp4`;
            downloadLink.style.display = 'none';
            downloadLink.target = '_blank'; // For cross-origin videos
            
            document.body.appendChild(downloadLink);
            downloadLink.click();
            document.body.removeChild(downloadLink);
            
            console.log('Download triggered');
            
            // Feedback visuel
            const downloadBtn = highlight.querySelector('.download-btn');
            if (downloadBtn) {
                const originalHTML = downloadBtn.innerHTML;
                downloadBtn.innerHTML = '<i class="fas fa-check"></i><span class="action-count">T√©l√©charg√©!</span>';
                
                setTimeout(() => {
                    downloadBtn.innerHTML = originalHTML;
                }, 2000);
                
                // Show success message
                showCustomAlert('T√©l√©chargement', 'Le t√©l√©chargement de la vid√©o a commenc√©', 'success');
            }
        } catch (error) {
            console.error('Download error:', error);
            showCustomAlert('Erreur de t√©l√©chargement', 'Impossible de t√©l√©charger la vid√©o', 'error');
        }
    } else {
        console.error('No valid video source available');
        showCustomAlert('Erreur', 'Vid√©o non disponible pour le t√©l√©chargement', 'error');
    }
}

function toggleCaption(highlightId) {
    const highlight = document.querySelector(`[data-highlight-id="${highlightId}"]`);
    const caption = highlight.querySelector('.caption');
    const showMoreBtn = highlight.querySelector('.show-more-btn');
    
    if (caption.style.webkitLineClamp) {
        caption.style.webkitLineClamp = '';
        showMoreBtn.innerHTML = '<i class="fas fa-minus"></i>';
    } else {
        caption.style.webkitLineClamp = '2';
        showMoreBtn.innerHTML = '<i class="fas fa-plus"></i>';
    }
}

function viewProfile(username) {
    window.location.href = `/profile/${username}/`;
}

function reportHighlight(highlightId) {
    // Impl√©menter le signalement
    showCustomAlert('Signalement', 'Fonctionnalit√© de signalement √† impl√©menter', 'info');
}

function deleteHighlight(highlightId) {
    showCustomDeleteAlert('‚ö†Ô∏è Supprimer le highlight', '√ätes-vous s√ªr de vouloir supprimer ce highlight ? Cette action est irr√©versible.', function() {
        // Supprimer le highlight
        fetch(`/highlights/${highlightId}/delete/`, {
            method: 'DELETE',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
        },
        }).then(response => {
            if (response.ok) {
                showCustomAlert('Suppression', 'Highlight supprim√© avec succ√®s', 'success');
                setTimeout(() => {
                    window.location.reload();
                }, 1500);
            } else {
                showCustomAlert('Erreur', 'Impossible de supprimer le highlight', 'error');
            }
        }).catch(error => {
            console.error('Erreur:', error);
            showCustomAlert('Erreur', 'Erreur de connexion', 'error');
        });
    });
}

// Fonction pour obtenir le cookie CSRF - AM√âLIOR√âE
function getCookie(name) {
    // Essayer d'abord depuis la meta tag
    const metaToken = document.querySelector('meta[name="csrf-token"]');
    if (metaToken && name === 'csrftoken') {
        return metaToken.getAttribute('content');
    }
    
    // Fallback vers les cookies
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    
    // Derni√®re tentative avec csrfmiddlewaretoken
    if (!cookieValue && name === 'csrftoken') {
        const csrfInput = document.querySelector('[name=csrfmiddlewaretoken]');
        if (csrfInput) {
            cookieValue = csrfInput.value;
        }
    }
    
    return cookieValue;
}

// Gestion des erreurs vid√©o
document.addEventListener('error', function(e) {
    if (e.target.tagName === 'VIDEO') {
        console.error('Erreur vid√©o:', e.target.error);
        // Afficher une image de fallback ou un message d'erreur
        const videoContainer = e.target.closest('.video-container');
        if (videoContainer) {
            videoContainer.innerHTML = `
                <div class="video-error">
                    <i class="fas fa-exclamation-triangle"></i>
                    <p>Erreur de chargement de la vid√©o</p>
                </div>
            `;
        }
    }
}, true);

// Auto-hide des menus au clic en dehors
document.addEventListener('click', function(event) {
    // Fermer le menu des options
    if (!event.target.closest('.more-options-btn') && !event.target.closest('.more-options-menu')) {
        document.querySelectorAll('.more-options-menu').forEach(menu => {
            menu.style.display = 'none';
        });
    }
});

// Gestion du responsive pour les fl√®ches de navigation
window.addEventListener('resize', function() {
    const navArrows = document.querySelector('.navigation-arrows');
    if (window.innerWidth <= 768) {
        navArrows.style.display = 'none';
    } else {
        navArrows.style.display = 'flex';
    }
});

// Am√©lioration : Auto-pause des vid√©os lors du scroll - OPTIMIS√â POUR √âVITER PAUSE AU HOVER
let scrollTimeout;
let isUserScrolling = false;
let lastScrollTop = 0;

document.querySelector('.highlights-viewer').addEventListener('scroll', function() {
    const currentScrollTop = this.scrollTop;
    const scrollDelta = Math.abs(currentScrollTop - lastScrollTop);
    
    // Only pause if there's significant scrolling (not just hover/mouse movement)
    // AND we're not just hovering over the video
    if (scrollDelta > 50 && !isMouseOverVideo) {
        clearTimeout(scrollTimeout);
        isUserScrolling = true;
        
        // Pause toutes les vid√©os pendant le scroll significatif
        document.querySelectorAll('video').forEach(video => {
            if (!video.paused) {
                video.pause();
            }
        });
        
        // Reprendre la lecture apr√®s l'arr√™t du scroll
        scrollTimeout = setTimeout(() => {
            isUserScrolling = false;
            const currentVideo = highlights[currentHighlightIndex]?.querySelector('video');
            if (currentVideo && !isUserScrolling) {
                currentVideo.play().catch(e => console.log('Autoplay prevented:', e));
            }
        }, 500); // D√©lai r√©duit pour une reprise plus rapide
    }
    
    lastScrollTop = currentScrollTop;
});

// Pr√©chargement intelligent des vid√©os
function preloadNearbyVideos() {
    const currentIndex = currentHighlightIndex;
    const preloadRange = 2; // Pr√©charger les 2 vid√©os suivantes et pr√©c√©dentes
    
    highlights.forEach((highlight, index) => {
        if (Math.abs(index - currentIndex) <= preloadRange) {
            const video = highlight.querySelector('video');
            if (video) {
                // S'assurer que la vid√©o a une source
                if (!video.src) {
                    const originalSrc = video.getAttribute('data-original-src');
                    if (originalSrc) {
                        video.src = originalSrc;
                        video.load();
                    }
                }
                // Pr√©charger les m√©tadonn√©es
                if (video.readyState < 1) {
                    video.preload = 'metadata';
                }
            }
        }
    });
}

// Am√©lioration : Gestion de la m√©moire pour les vid√©os - OPTIMIS√âE
function optimizeVideoMemory() {
    highlights.forEach((highlight, index) => {
        if (Math.abs(index - currentHighlightIndex) > 3) { // Augment√© √† 3 pour √©viter les probl√®mes
            const video = highlight.querySelector('video');
            if (video) {
                video.pause();
                video.currentTime = 0;
                // Ne pas supprimer la source pour √©viter les probl√®mes de chargement
                // video.src = '';
                // video.load();
            }
        }
    });
}

// Optimiser la m√©moire toutes les 60 secondes (r√©duit la fr√©quence)
setInterval(optimizeVideoMemory, 60000);

// Am√©lioration : D√©tection de la visibilit√© des highlights
function isHighlightVisible(highlight) {
    const rect = highlight.getBoundingClientRect();
    const container = document.getElementById('highlightsViewer');
    const containerRect = container.getBoundingClientRect();
    
    return rect.top >= containerRect.top && rect.bottom <= containerRect.bottom;
}

// Am√©lioration : Gestion intelligente de la lecture vid√©o - NON INTRUSIVE
function manageVideoPlayback() {
    // Only run if not currently scrolling to avoid conflicts
    if (isUserScrolling) return;
    
    highlights.forEach((highlight, index) => {
        const video = highlight.querySelector('video');
        if (video) {
            // Ensure video has proper source
            if (!video.src && video.getAttribute('data-original-src')) {
                video.src = video.getAttribute('data-original-src');
                video.load();
            }
            
            // Pr√©charger les m√©tadonn√©es pour toutes les vid√©os visibles
            if (Math.abs(index - currentHighlightIndex) <= 2) {
                if (video.readyState < 1) {
                    video.preload = 'metadata';
                }
            }
            
            // Only manage playback for the current highlight to avoid conflicts
            if (index === currentHighlightIndex && isHighlightVisible(highlight)) {
                // Vid√©o visible et active - la faire jouer SEULEMENT si elle n'est pas d√©j√† en cours
                if (video.paused && video.readyState >= 2) {
                    video.play().catch(e => console.log('Autoplay prevented:', e));
                }
            }
            // Don't automatically pause other videos unless they're far from current
            else if (Math.abs(index - currentHighlightIndex) > 1) {
                // Seulement mettre en pause les vid√©os √©loign√©es
                if (!video.paused) {
                    video.pause();
                }
            }
        }
    });
}

// Fonction pour extraire l'ID du highlight depuis l'URL
function getTargetHighlightFromUrl() {
    // V√©rifier les param√®tres URL pour un highlight sp√©cifique
    const urlParams = new URLSearchParams(window.location.search);
    const highlightId = urlParams.get('highlight');
    
    // V√©rifier aussi le hash de l'URL
    const hash = window.location.hash;
    if (hash.startsWith('#highlight-')) {
        return hash.replace('#highlight-', '');
    }
    
    return highlightId;
}

// Fonction pour naviguer vers un highlight sp√©cifique
function navigateToHighlight(highlightId) {
    const targetIndex = highlights.findIndex(h => h.getAttribute('data-highlight-id') === highlightId);
    if (targetIndex !== -1) {
        showHighlight(targetIndex, true); // Navigation instantan√©e
        // Mettre √† jour l'URL sans recharger la page
        const newUrl = new URL(window.location);
        newUrl.searchParams.set('highlight', highlightId);
        window.history.replaceState({}, '', newUrl);
    }
}

// R√©duire la fr√©quence pour √©viter les interf√©rences (toutes les 2 secondes au lieu de 1)
setInterval(manageVideoPlayback, 2000);

// Am√©lioration : Gestion des erreurs de scroll
function handleScrollError() {
    const container = document.getElementById('highlightsViewer');
    if (container) {
        container.addEventListener('scroll', function() {
            // Emp√™cher le scroll horizontal
            if (this.scrollLeft !== 0) {
                this.scrollLeft = 0;
            }
        });
    }
}

// Initialiser la gestion des erreurs de scroll
document.addEventListener('DOMContentLoaded', function() {
    handleScrollError();
});
    </script>
    
    <!-- Variables globales pour le feed -->
    <script>
        // Variables globales pour le nouveau syst√®me
        window.feedType = '{{ feed_type|default:"for_you" }}';
        window.loadMode = '{{ load_mode|default:"initial" }}';
        window.targetHighlightId = '{{ target_highlight_id|default:"" }}';
        window.userAuthenticated = {{ user.is_authenticated|yesno:"true,false" }};
    </script>
    
    <!-- Nouveau syst√®me de feed TikTok-like -->
    <script src="{% static 'js/tiktok-feed.js' %}"></script>
    
    <!-- Script pour le syst√®me d'appr√©ciation -->
    <script src="{% static 'js/appreciation.js' %}"></script>
</body>
</html>