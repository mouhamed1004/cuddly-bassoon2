{% extends 'base.html' %}
{% load static %}
{% load i18n %}

{% block content %}
<div class="auth-container">
    <div class="auth-card">
        <h2>Nouveau mot de passe</h2>
        
        {% for message in messages %}
            <div class="{% if message.tags == 'error' %}error-message{% else %}success-message{% endif %}">
                {{ message }}
            </div>
        {% endfor %}
        
        <div class="reset-info">
            <i class="fas fa-user"></i>
            <p>Réinitialisation du mot de passe pour <strong>{{ user.username }}</strong></p>
        </div>
        
        <form method="POST" class="auth-form" id="resetForm">
            {% csrf_token %}
            <input type="hidden" name="token" value="{{ token }}">
            
            <div class="form-group">
                <label for="new_password">
                    <i class="fas fa-lock"></i>
                    Nouveau mot de passe
                </label>
                <input type="password" id="new_password" name="new_password" required 
                       placeholder="Entrez votre nouveau mot de passe"
                       minlength="8">
                <div class="password-strength" id="passwordStrength">
                    <div class="strength-bar">
                        <div class="strength-fill" id="strengthFill"></div>
                    </div>
                    <span class="strength-text" id="strengthText">Entrez un mot de passe</span>
                </div>
            </div>
            
            <div class="form-group">
                <label for="confirm_password">
                    <i class="fas fa-lock"></i>
                    Confirmer le mot de passe
                </label>
                <input type="password" id="confirm_password" name="confirm_password" required 
                       placeholder="Confirmez votre nouveau mot de passe">
                <div class="password-match" id="passwordMatch">
                    <i class="fas fa-check-circle"></i>
                    <span>Les mots de passe correspondent</span>
                </div>
                <div class="password-mismatch" id="passwordMismatch">
                    <i class="fas fa-exclamation-triangle"></i>
                    <span>Les mots de passe ne correspondent pas</span>
                </div>
            </div>
            
            <div class="password-requirements">
                <h4>Exigences du mot de passe :</h4>
                <ul>
                    <li id="req-length">Au moins 8 caractères</li>
                    <li id="req-uppercase">Une majuscule</li>
                    <li id="req-lowercase">Une minuscule</li>
                    <li id="req-number">Un chiffre</li>
                    <li id="req-special">Un caractère spécial</li>
                </ul>
            </div>
            
            <button type="submit" class="auth-button" id="submitButton" disabled>
                <i class="fas fa-key"></i>
                Réinitialiser le mot de passe
            </button>
        </form>
        
        <div class="auth-links">
            <a href="{% url 'signin' %}" class="auth-link">
                <i class="fas fa-arrow-left"></i>
                Retour à la connexion
            </a>
        </div>
    </div>
</div>

<style>
.auth-container {
    min-height: 80vh;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 2rem;
}

.auth-card {
    background: rgba(15, 23, 41, 0.95);
    border-radius: 15px;
    padding: 2.5rem;
    width: 100%;
    max-width: 500px;
    border: 1px solid var(--primary-color);
    box-shadow: 0 0 30px rgba(108, 92, 231, 0.2);
}

.auth-card h2 {
    text-align: center;
    color: var(--primary-color);
    font-family: 'RussoOne', sans-serif;
    font-size: 2rem;
    margin-bottom: 2rem;
    text-shadow: 0 0 15px var(--primary-color);
}

.error-message {
    background: rgba(255, 0, 0, 0.1);
    border: 1px solid #ff0000;
    color: #ff0000;
    padding: 1rem;
    border-radius: 8px;
    margin-bottom: 1.5rem;
    text-align: center;
}

.success-message {
    background: rgba(0, 255, 136, 0.1);
    border: 1px solid #00ff88;
    color: #00ff88;
    padding: 1rem;
    border-radius: 8px;
    margin-bottom: 1.5rem;
    text-align: center;
}

.reset-info {
    background: rgba(108, 92, 231, 0.1);
    border: 1px solid var(--primary-color);
    border-radius: 8px;
    padding: 1rem;
    margin-bottom: 2rem;
    display: flex;
    align-items: center;
    gap: 0.8rem;
    color: var(--text-color);
}

.reset-info i {
    color: var(--primary-color);
    font-size: 1.2rem;
}

.reset-info p {
    margin: 0;
    line-height: 1.5;
}

.form-group {
    margin-bottom: 1.5rem;
}

.form-group label {
    display: block;
    margin-bottom: 0.5rem;
    color: var(--text-color);
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.form-group input {
    width: 100%;
    padding: 0.8rem;
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid var(--primary-color);
    border-radius: 8px;
    color: var(--text-color);
    transition: all 0.3s ease;
    box-sizing: border-box;
}

.form-group input:focus {
    outline: none;
    box-shadow: 0 0 15px var(--primary-color);
}

.password-strength {
    margin-top: 0.5rem;
}

.strength-bar {
    width: 100%;
    height: 4px;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 2px;
    overflow: hidden;
    margin-bottom: 0.5rem;
}

.strength-fill {
    height: 100%;
    width: 0%;
    transition: all 0.3s ease;
    border-radius: 2px;
}

.strength-fill.weak { background: #ff4757; width: 25%; }
.strength-fill.fair { background: #ffa502; width: 50%; }
.strength-fill.good { background: #2ed573; width: 75%; }
.strength-fill.strong { background: #00ff88; width: 100%; }

.strength-text {
    font-size: 0.85rem;
    color: var(--text-color);
}

.password-match {
    margin-top: 0.5rem;
    display: none;
    align-items: center;
    gap: 0.5rem;
    color: #00ff88;
    font-size: 0.85rem;
}

.password-match.show {
    display: flex;
}

.password-mismatch {
    margin-top: 0.5rem;
    display: none;
    align-items: center;
    gap: 0.5rem;
    color: #ff4757;
    font-size: 0.85rem;
}

.password-mismatch.show {
    display: flex;
}

.password-requirements {
    background: rgba(255, 255, 255, 0.02);
    border: 1px solid rgba(108, 92, 231, 0.3);
    border-radius: 8px;
    padding: 1rem;
    margin-bottom: 1.5rem;
}

.password-requirements h4 {
    color: var(--primary-color);
    margin: 0 0 0.8rem 0;
    font-size: 0.9rem;
}

.password-requirements ul {
    list-style: none;
    padding: 0;
    margin: 0;
}

.password-requirements li {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-bottom: 0.3rem;
    font-size: 0.85rem;
    color: var(--text-color);
}

.password-requirements li:before {
    content: "✗";
    color: #ff4757;
    font-weight: bold;
}

.password-requirements li.valid:before {
    content: "✓";
    color: #00ff88;
}

.auth-button {
    width: 100%;
    padding: 1rem;
    background: var(--primary-color);
    border: none;
    border-radius: 8px;
    color: white;
    font-size: 1rem;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    margin-bottom: 1.5rem;
}

.auth-button:hover:not(:disabled) {
    transform: translateY(-2px);
    box-shadow: 0 0 20px var(--primary-color);
}

.auth-button:disabled {
    opacity: 0.6;
    cursor: not-allowed;
    transform: none !important;
    box-shadow: none !important;
}

.auth-links {
    display: flex;
    flex-direction: column;
    gap: 1rem;
    text-align: center;
}

.auth-link {
    color: var(--text-color);
    text-decoration: none;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    padding: 0.5rem;
    border-radius: 6px;
}

.auth-link:hover {
    color: var(--primary-color);
    background: rgba(108, 92, 231, 0.1);
    transform: translateX(5px);
}

/* Responsive */
@media (max-width: 768px) {
    .auth-container {
        padding: 1rem;
    }
    
    .auth-card {
        padding: 2rem;
    }
    
    .auth-card h2 {
        font-size: 1.5rem;
    }
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const newPasswordInput = document.getElementById('new_password');
    const confirmPasswordInput = document.getElementById('confirm_password');
    const strengthFill = document.getElementById('strengthFill');
    const strengthText = document.getElementById('strengthText');
    const passwordMatch = document.getElementById('passwordMatch');
    const passwordMismatch = document.getElementById('passwordMismatch');
    const submitButton = document.getElementById('submitButton');
    
    // Validation de la force du mot de passe
    function calculatePasswordStrength(password) {
        let score = 0;
        const requirements = {
            length: password.length >= 8,
            uppercase: /[A-Z]/.test(password),
            lowercase: /[a-z]/.test(password),
            number: /\d/.test(password),
            special: /[!@#$%^&*(),.?":{}|<>]/.test(password)
        };
        
        // Mettre à jour les indicateurs visuels
        document.getElementById('req-length').classList.toggle('valid', requirements.length);
        document.getElementById('req-uppercase').classList.toggle('valid', requirements.uppercase);
        document.getElementById('req-lowercase').classList.toggle('valid', requirements.lowercase);
        document.getElementById('req-number').classList.toggle('valid', requirements.number);
        document.getElementById('req-special').classList.toggle('valid', requirements.special);
        
        // Calculer le score
        Object.values(requirements).forEach(req => {
            if (req) score++;
        });
        
        return { score, requirements };
    }
    
    // Vérification de correspondance des mots de passe
    function checkPasswordMatch() {
        const newPassword = newPasswordInput.value;
        const confirmPassword = confirmPasswordInput.value;
        
        // Masquer les deux indicateurs d'abord
        passwordMatch.classList.remove('show');
        passwordMismatch.classList.remove('show');
        
        if (confirmPassword.length === 0) {
            // Pas de confirmation saisie
            return false;
        } else if (newPassword === confirmPassword) {
            // Les mots de passe correspondent
            passwordMatch.classList.add('show');
            return true;
        } else {
            // Les mots de passe ne correspondent pas
            passwordMismatch.classList.add('show');
            return false;
        }
    }
    
    // Validation complète
    function validateForm() {
        const newPassword = newPasswordInput.value;
        const { requirements } = calculatePasswordStrength(newPassword);
        const passwordsMatch = checkPasswordMatch();
        
        const allRequirementsMet = Object.values(requirements).every(req => req);
        const isValid = allRequirementsMet && passwordsMatch && newPassword.length > 0;
        
        submitButton.disabled = !isValid;
    }
    
    // Événements
    newPasswordInput.addEventListener('input', function() {
        const password = this.value;
        const { score } = calculatePasswordStrength(password);
        
        // Mettre à jour la barre de force
        strengthFill.className = 'strength-fill';
        if (score >= 5) {
            strengthFill.classList.add('strong');
            strengthText.textContent = 'Très fort';
        } else if (score >= 4) {
            strengthFill.classList.add('good');
            strengthText.textContent = 'Fort';
        } else if (score >= 3) {
            strengthFill.classList.add('fair');
            strengthText.textContent = 'Moyen';
        } else if (score >= 1) {
            strengthFill.classList.add('weak');
            strengthText.textContent = 'Faible';
        } else {
            strengthText.textContent = 'Entrez un mot de passe';
        }
        
        validateForm();
    });
    
    confirmPasswordInput.addEventListener('input', validateForm);
    
    // Gestion du formulaire
    document.getElementById('resetForm').addEventListener('submit', function() {
        submitButton.disabled = true;
        submitButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Réinitialisation...';
    });
});
</script>
{% endblock %}
